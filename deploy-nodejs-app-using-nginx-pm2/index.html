<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.47108c02bcddbdfcd93a.css" data-identity="gatsby-global-css">code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#ccc;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}pre[class*=language-].line-numbers{counter-reset:linenumber;padding-left:3.8em;position:relative}pre[class*=language-].line-numbers>code{position:relative;white-space:inherit}.line-numbers .line-numbers-rows{border-right:1px solid #999;font-size:100%;left:-3.8em;letter-spacing:-1px;pointer-events:none;position:absolute;top:0;-webkit-user-select:none;-ms-user-select:none;user-select:none;width:3em}.line-numbers-rows>span{counter-increment:linenumber;display:block}.line-numbers-rows>span:before{color:#999;content:counter(linenumber);display:block;padding-right:.8em;text-align:right}html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol}body{font-size:1.1rem;margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{-webkit-text-decoration-skip:objects;background-color:transparent}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{box-sizing:border-box;font-size:130.5%/1.45em;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{word-wrap:break-word;color:rgba(0,0,0,.8);font-weight:400}img{margin:0 0 1.45rem;max-width:100%;padding:0}h1,h2,h3,h4,h5,h6{text-rendering:optimizeLegibility;color:inherit;font-weight:600;margin:0 0 .5em;padding:0}h1{font-size:2.25rem}h2{font-size:1.8em}h3{font-size:1.6em}h4{font-size:1rem}h5{font-size:.875em}h6{font-size:.85em}hgroup{margin:0 0 1.45rem;padding:0}ol,ul{list-style-image:none;list-style-position:outside;margin:0 0 1.45rem 1.45rem;padding:0}dd,dl,p{margin:0 0 1.45rem;padding:0}p{line-height:1.5}figure{padding:0}figure,pre{margin:0 0 1.45rem}pre{word-wrap:normal;background:rgba(0,0,0,.04);border-radius:3px;font-size:.85rem;line-height:1.42;overflow:auto;padding:1.45rem}table{border-collapse:collapse;font-size:1rem;line-height:1.45rem;width:100%}fieldset,table{margin:0 0 1.45rem;padding:0}blockquote{border-left:2px solid #999;font-style:italic;margin:5px auto;padding:.5em}blockquote:before{display:none}blockquote:not(:first-of-type){margin-top:.5em}blockquote p{color:#555;font-size:12pt;line-height:1.4}blockquote footer{color:#777;font-size:12pt;margin-top:.5em;padding:0;text-align:left}blockquote footer:before{content:"— "}@element "blockquote" and (min-width: 300px){blockquote{padding:1em 20% 1em 1em}blockquote p{font-size:14pt}}form,iframe,noscript{margin:0 0 1.45rem;padding:0}hr{background:rgba(0,0,0,.2);border:none;height:1px;margin:0 0 calc(1.45rem - 1px);padding:0}address{margin:0 0 1.45rem;padding:0}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-bottom:.725rem;margin-left:1.45rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";border-bottom:1px solid rgba(0,0,0,.12);padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}@media only screen and (max-width:480px){html{font-size:100%}}footer{margin-top:1em}.site-title{font-size:2em;font-weight:700;margin-bottom:10px}.site-title a{color:inherit;text-decoration:none}.site-sub-title{font-style:italic;margin-bottom:0}.post-title{margin-bottom:0}h3.post-title{font-size:1.2em}.post-tag-container{margin:10px 0}.post-meta{margin-bottom:5px}.post-content p{line-height:1.8}.post-content h2{border-bottom:1px solid #eaecef;padding-bottom:.3em}button{cursor:pointer}a{color:#639;text-decoration:none}ul.prev-next{list-style:none;margin-left:0}ul.prev-next li span{font-weight:700;margin-right:.5em}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:SFMono-Regular,Consolas,Roboto Mono,Droid Sans Mono,Liberation Mono,Menlo,Courier,monospace;padding:.2em 0}:not(pre)>code[class*=language-]{border-radius:.2em;padding:.15em}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{letter-spacing:-.2em}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}:not(pre)>code[class*=language-text]{background:#f1f1f1;color:inherit}code[class*=language-],pre[class*=language-]{font-size:.9rem}.gatsby-highlight-code-line{background-color:#717171;border-left:.25em solid #6196cc;display:block;margin-left:-1em;margin-right:-1em;padding-left:.75em;padding-right:1em}.gatsby-highlight{background-color:#2d2d2d;border-radius:.2em;margin:.5em 0;overflow:auto;padding:1em}.gatsby-highlight pre[class*=language-]{background-color:transparent;float:left;margin:0;min-width:100%;overflow:initial;padding:0}.gatsby-highlight pre[class*=language-].line-numbers{overflow:initial;padding:0 0 0 2.8em}</style><meta name="generator" content="Gatsby 3.12.0"/><title data-react-helmet="true">Deploy Nodejs app sử dụng Nginx + PM2 | Chung Tran</title><meta data-react-helmet="true" name="description" content="Trong tút này chúng ta sẽ thực hiện deploy nodejs app với sơ đồ như sau:
 Đây là sơ đồ hệ thống deploy nodejs đơn giản nhất, tùy vào yêu cầu có thể sẽ phức tạp…"/><meta data-react-helmet="true" property="og:title" content="Deploy Nodejs app sử dụng Nginx + PM2"/><meta data-react-helmet="true" property="og:description" content="Trong tút này chúng ta sẽ thực hiện deploy nodejs app với sơ đồ như sau:
 Đây là sơ đồ hệ thống deploy nodejs đơn giản nhất, tùy vào yêu cầu có thể sẽ phức tạp…"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" property="og:image" content="https://avatars1.githubusercontent.com/u/28822504?s=400&amp;v=4"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="@chungtran4078"/><meta data-react-helmet="true" name="twitter:title" content="Deploy Nodejs app sử dụng Nginx + PM2"/><meta data-react-helmet="true" name="twitter:description" content="Trong tút này chúng ta sẽ thực hiện deploy nodejs app với sơ đồ như sau:
 Đây là sơ đồ hệ thống deploy nodejs đơn giản nhất, tùy vào yêu cầu có thể sẽ phức tạp…"/><meta data-react-helmet="true" name="google-site-verification" content="OXO63UNlYgp3J5znjIDm1AWeHj7MCcoSLxJV3ucTSUo"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){if(void 0===e.target.dataset.mainImage)return;if(void 0===e.target.dataset.gatsbyImageSsr)return;const t=e.target;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="icon" href="/favicon-32x32.png?v=4a9773549091c227cd2eb82ccd9c5e3a" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="sitemap" type="application/xml" href="/sitemap/sitemap-index.xml"/><link as="script" rel="preload" href="/webpack-runtime-0dc5f90dcd7e00f63e25.js"/><link as="script" rel="preload" href="/framework-d48b262dedbf1fafd12c.js"/><link as="script" rel="preload" href="/app-fd454e6b17fe15d481e1.js"/><link as="script" rel="preload" href="/commons-7811b15a21818df9f744.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-tsx-7b28b2b100cbd4db9766.js"/><link as="fetch" rel="preload" href="/page-data/deploy-nodejs-app-using-nginx-pm2/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/3649515864.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/3894061898.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div><div style="margin:0 auto;max-width:960px;padding:1.45rem 1.0875rem"><div class="site-title"><a href="/">Chung Tran</a></div><p class="site-sub-title">Lôm côm, ba lăng nhăng.</p></div><div style="margin:0 auto;max-width:960px;padding:0px 1.0875rem 1.45rem;padding-top:0"><div class="post-meta"><h1 class="post-title">Deploy Nodejs app sử dụng Nginx + PM2</h1><small>Date: <!-- -->2020-04-08<!-- --> | Category: <a style="text-decoration:none" href="/categories/nodejs">Nodejs</a></small></div><hr/><div class="post-content"><div><p>Trong tút này chúng ta sẽ thực hiện deploy nodejs app với sơ đồ như sau:
<span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/744076a86e2e3a876ff825dd4b5677c6/11b9b/pm2.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 45.94594594594595%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAFxGAABcRgEUlENBAAABZUlEQVQoz31QTUsCQRjen1E/JegUBNUhKIKgQ3SPgrpE96izVoeQsig8FNYSRpRQkOGhKPy4Wciqq2Cuq/sxO7s7887EuImC2MMwl+dzRuIDYJ07lDVGoqUJuaYiiq8y9e27+mrceS0KAQQSLpnXeTOes27yZuzTU3QqSMF9t0lCQfmmJ5TAKAHiU9Ad0B2qI2g50HKk6vypOnuiLpyVxg/sZEF4KQTBPmXQCQriQEfqXLQyHanMRCqTR8pYWAp0wZCXKl5PaV53lekB+XPz84K1l9ZoruZmqm62it8r+K0sMQqMikmc88OcMXqslA2/7fgN29UxbTqkbmHPp4sP9Sm51v8p4s39zR8/7n6mZSDiuQT5YLi+7RMs2plcRJdfNgfgtHckPgSMcZdyRBgfDqmn5ZxoqLZ5qy5daGuypqOtp93l+4RFxDLKOLB/zWBgPZxq7CSNUKpl4I3n2Mpj2iZdeqD5FwrJ7UoRicW0AAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Pm2"
        title="Pm2"
        src="/static/744076a86e2e3a876ff825dd4b5677c6/fcda8/pm2.png"
        srcset="/static/744076a86e2e3a876ff825dd4b5677c6/12f09/pm2.png 148w,
/static/744076a86e2e3a876ff825dd4b5677c6/e4a3f/pm2.png 295w,
/static/744076a86e2e3a876ff825dd4b5677c6/fcda8/pm2.png 590w,
/static/744076a86e2e3a876ff825dd4b5677c6/efc66/pm2.png 885w,
/static/744076a86e2e3a876ff825dd4b5677c6/c83ae/pm2.png 1180w,
/static/744076a86e2e3a876ff825dd4b5677c6/11b9b/pm2.png 5375w"
        sizes="(max-width: 590px) 100vw, 590px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>Đây là sơ đồ hệ thống deploy nodejs đơn giản nhất, tùy vào yêu cầu có thể sẽ phức tạp hơn như kết hợp CI để quá trình unit test và deploy diễn ra tự động.</p>
<p><strong>Mình giải thích sơ đồ này 1 chút:</strong></p>
<p>Khi thực hiện deploy thì máy <strong>Local</strong> sẽ ssh vào 2 server <strong>Test</strong> và <strong>Production</strong>.</p>
<p>Sau đó đọc file cấu hình deploy của pm2 (ecosystem.config.js) để thực hiện pull source code từ git repository theo branch tương ứng.</p>
<p>Cuối cùng là start các instance với source code đã pull.</p>
<h3>Thực hiện</h3>
<ul>
<li>Đầu tiên phải đảm bảo rằng Local và các server đã thiết lập môi trường giống như sơ đồ (nginx, git, nodejs…phải đầy đủ đồ chơi nha).</li>
<li>Thứ high là đảm bảo rằng server Test và Production đã được add SSH key của Local, nếu không khi deploy sẽ phải nhập tay password.</li>
<li>Thứ bar là đảm bảo rằng tài khoản trên dịch vụ Git (GitHub, GitLab, Bitbucket…) của bạn đã được add SSH key của server Test và Production, nếu ko thì sẽ bị như bên trên.</li>
<li>Cuối cùng là phải có 1 Nodejs app =)).</li>
</ul>
<p>Sau khi pass các điều kiện trên thì bắt đầu thôi, config 1 chút trên server trước.</p>
<p><strong>Trên Test server:</strong></p>
<p>Run thần chú <code class="language-text">sudo vi /etc/nginx/sites-available/default</code> để mở file config nginx và cập nhật lại như sau:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">server <span class="token punctuation">{</span>
    listen <span class="token number">80</span><span class="token punctuation">;</span>

    server_name example.com<span class="token punctuation">;</span>

    location / <span class="token punctuation">{</span>
        proxy_pass http://localhost:3000<span class="token punctuation">;</span>
        proxy_http_version <span class="token number">1.1</span><span class="token punctuation">;</span>
        proxy_set_header Upgrade <span class="token variable">$http_upgrade</span><span class="token punctuation">;</span>
        proxy_set_header Connection <span class="token string">'upgrade'</span><span class="token punctuation">;</span>
        proxy_set_header Host <span class="token variable">$host</span><span class="token punctuation">;</span>
        proxy_cache_bypass <span class="token variable">$http_upgrade</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Đọc file trên đủ hiểu vai trò của nginx rồi nhé, khi người dùng truy cập <code class="language-text">192.168.1.3</code> với http port mặc định là 80 thì nginx sẽ reverse proxy thành <code class="language-text">http://localhost:3000</code> (3000 chính là port mình start nodejs app)</p>
<p><strong>Trên Production server:</strong>
Tương tự như trên Test server.</p>
<p><strong>Tại thư mục project trên Local:</strong></p>
<p>Run thần chú <code class="language-text">pm2 ecosystem</code> để genarate ra file <strong>ecosystem.config.js</strong></p>
<p>File này ban đầu sẽ có nội dung tương tự như sau:</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  apps <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'API'</span><span class="token punctuation">,</span>
    script<span class="token operator">:</span> <span class="token string">'app.js'</span><span class="token punctuation">,</span>

    <span class="token comment">// Options reference: https://pm2.keymetrics.io/docs/usage/application-declaration/</span>
    args<span class="token operator">:</span> <span class="token string">'one two'</span><span class="token punctuation">,</span>
    instances<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    autorestart<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    watch<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    max_memory_restart<span class="token operator">:</span> <span class="token string">'1G'</span><span class="token punctuation">,</span>
    env<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token constant">NODE_ENV</span><span class="token operator">:</span> <span class="token string">'development'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    env_production<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token constant">NODE_ENV</span><span class="token operator">:</span> <span class="token string">'production'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

  deploy <span class="token operator">:</span> <span class="token punctuation">{</span>
    production <span class="token operator">:</span> <span class="token punctuation">{</span>
      user <span class="token operator">:</span> <span class="token string">'node'</span><span class="token punctuation">,</span>
      host <span class="token operator">:</span> <span class="token string">'212.83.163.1'</span><span class="token punctuation">,</span>
      ref  <span class="token operator">:</span> <span class="token string">'origin/master'</span><span class="token punctuation">,</span>
      repo <span class="token operator">:</span> <span class="token string">'git@github.com:repo.git'</span><span class="token punctuation">,</span>
      path <span class="token operator">:</span> <span class="token string">'/var/www/production'</span><span class="token punctuation">,</span>
      <span class="token string">'post-deploy'</span> <span class="token operator">:</span> <span class="token string">'npm install &amp;&amp; pm2 reload ecosystem.config.js --env production'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span></code></pre></div>
<p>Mình cần thay đổi lại cho phù hợp với yêu cầu:</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    apps<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">'test-pm2'</span><span class="token punctuation">,</span>
        append_env_to_name<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        script<span class="token operator">:</span> <span class="token string">'server.js'</span><span class="token punctuation">,</span>
        instances<span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
        autorestart<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        max_memory_restart<span class="token operator">:</span> <span class="token string">'1G'</span><span class="token punctuation">,</span>
        env<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// common env variable</span>
            <span class="token constant">NODE_ENV</span><span class="token operator">:</span> <span class="token string">'development'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        env_production<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// khi deploy với option --env production</span>
            <span class="token constant">NODE_ENV</span><span class="token operator">:</span> <span class="token string">"production"</span><span class="token punctuation">,</span>
            <span class="token constant">PORT</span><span class="token operator">:</span> <span class="token number">3000</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        env_development<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// khi deploy với option --env development</span>
            <span class="token constant">NODE_ENV</span><span class="token operator">:</span> <span class="token string">"development"</span><span class="token punctuation">,</span>
            <span class="token constant">PORT</span><span class="token operator">:</span> <span class="token number">3000</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    deploy<span class="token operator">:</span> <span class="token punctuation">{</span>
        production<span class="token operator">:</span> <span class="token punctuation">{</span>
            user<span class="token operator">:</span> <span class="token string">'chungtran-prod'</span><span class="token punctuation">,</span> <span class="token comment">// user để ssh</span>
            host<span class="token operator">:</span> <span class="token string">'192.168.1.9'</span><span class="token punctuation">,</span> <span class="token comment">// IP của server này (theo sơ đồ)</span>
            ref<span class="token operator">:</span> <span class="token string">'origin/master'</span><span class="token punctuation">,</span> <span class="token comment">// branch để pull source</span>
            repo<span class="token operator">:</span> <span class="token string">'git@github.com:chungtran4078/demo-pm2.git'</span><span class="token punctuation">,</span> <span class="token comment">// repo của project</span>
            path<span class="token operator">:</span> <span class="token string">'/var/www/html/demo-pm2'</span><span class="token punctuation">,</span> <span class="token comment">// sẽ deploy vào thư mục này</span>
            <span class="token string">'post-deploy'</span><span class="token operator">:</span> <span class="token string">'yarn install &amp;&amp; pm2 startOrRestart ecosystem.config.js --env production'</span> <span class="token comment">// cmd để deploy</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        development<span class="token operator">:</span> <span class="token punctuation">{</span>
            user<span class="token operator">:</span> <span class="token string">'chungtran-dev'</span><span class="token punctuation">,</span>
            host<span class="token operator">:</span> <span class="token string">'192.168.1.3'</span><span class="token punctuation">,</span>
            ref<span class="token operator">:</span> <span class="token string">'origin/develop'</span><span class="token punctuation">,</span>
            repo<span class="token operator">:</span> <span class="token string">'git@github.com:chungtran4078/demo-pm2.git'</span><span class="token punctuation">,</span>
            path<span class="token operator">:</span> <span class="token string">'/var/www/html/demo-pm2'</span><span class="token punctuation">,</span>
            <span class="token string">'post-deploy'</span><span class="token operator">:</span> <span class="token string">'yarn install &amp;&amp; pm2 startOrRestart ecosystem.config.js --env development'</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>Nội dung trên cũng khá dễ hiểu rồi, nếu chưa hiểu có thể xem document này nha: <a href="https://pm2.keymetrics.io/docs/usage/deployment/#complete-tutorial" target="_blank" rel="nofollow">https://pm2.keymetrics.io/docs/usage/deployment/#complete-tutorial</a></p>
<p>Nhớ là phải push file này lên git cùng với source code nữa nha. Vì server sau khi pull về nó sẽ đọc file này để deploy.</p>
<p>Xong xuôi hết chưa?
Chạy lần lượt các cmd sau để deploy lên Test server:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">pm2 deploy ecosystem.config.js development setup <span class="token comment"># setup ban đầu để chuẩn bị deploy như tạo thư mục, pull code...</span>
pm2 deploy ecosystem.config.js development <span class="token comment"># tiến hành deploy</span></code></pre></div>
<p>Tương tự với Production server luôn.</p>
<p>Truy cập <code class="language-text">192.168.1.3</code> để xem app mà mình đã deploy từ branch develop và <code class="language-text">192.168.1.9</code> để xem app mà mình đã deploy từ branch master.</p></div></div><div class="post-tag-container"><span>Tags: </span><a style="text-decoration:none" href="/tags/linux"><button>linux</button></a><a style="text-decoration:none" href="/tags/nodejs"><button>nodejs</button></a><a style="text-decoration:none" href="/tags/nginx"><button>nginx</button></a></div><hr/><ul class="prev-next"><li><span>Prev:</span><a rel="prev" href="/docker-cho-be-p3/">Docker cho bé - P3: Chạy nhiều container với Docker-compose</a></li><li><span>Next:</span><a rel="next" href="/tai-sao-moi-nguoi-kho-chiu-voi-vue3/">Vue 3 drama: Tại sao mọi người khó chịu với Vue 3</a></li></ul><footer>© me 2018, Built with <a target="_blank" rel="noopener noreferrer" href="https://www.gatsbyjs.org">Gatsby</a></footer></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/deploy-nodejs-app-using-nginx-pm2/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-e66811e0b6688dcb4ebf.js"],"app":["/app-fd454e6b17fe15d481e1.js"],"component---src-pages-404-jsx":["/component---src-pages-404-jsx-6e2e6289dc996384000d.js"],"component---src-pages-index-tsx":["/component---src-pages-index-tsx-7cabc6055ef6a09eefe2.js"],"component---src-templates-blog-post-tsx":["/component---src-templates-blog-post-tsx-7b28b2b100cbd4db9766.js"],"component---src-templates-category-tsx":["/component---src-templates-category-tsx-d7a9e4fde2393c584ae5.js"],"component---src-templates-tag-tsx":["/component---src-templates-tag-tsx-5f8055ed686dece0b499.js"]};/*]]>*/</script><script src="/polyfill-e66811e0b6688dcb4ebf.js" nomodule=""></script><script src="/component---src-templates-blog-post-tsx-7b28b2b100cbd4db9766.js" async=""></script><script src="/commons-7811b15a21818df9f744.js" async=""></script><script src="/app-fd454e6b17fe15d481e1.js" async=""></script><script src="/framework-d48b262dedbf1fafd12c.js" async=""></script><script src="/webpack-runtime-0dc5f90dcd7e00f63e25.js" async=""></script></body></html>