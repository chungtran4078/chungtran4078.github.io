{"componentChunkName":"component---src-templates-blog-post-js","path":"/deploy-nodejs-app-using-nginx-pm2/","result":{"data":{"site":{"siteMetadata":{"title":"Chung Tran","author":"@chungtran4078"}},"markdownRemark":{"id":"44680309-12d1-5bfd-9b33-f23609018f6f","excerpt":"Trong tút này chúng ta sẽ thực hiện deploy nodejs app với sơ đồ như sau:\n Đây là sơ đồ hệ thống deploy nodejs đơn giản nhất, tùy vào yêu cầu có thể sẽ phức tạp…","html":"<p>Trong tút này chúng ta sẽ thực hiện deploy nodejs app với sơ đồ như sau:\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/744076a86e2e3a876ff825dd4b5677c6/11b9b/pm2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.94594594594595%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAFxGAABcRgEUlENBAAABZUlEQVQoz31Qy0rDQBTNVwiu/QdBXHflSgWXUhChCxf+QXciFEVUcGEp1YLFR7EgVXdFFKFBqdSNVlpbtSZ9JJk4SSfJ5GZMmtaAr8vhzgzncS/DsR/l9HrqEQ8nXyZOhLYJWupGXMwKc/vdq6onAMfXcVZV8vAsW5WOjU17EHFa70Z5Of2k6dSBFjYqEim3ARtBPGNcbWyjPrpWH9+sjCxp5w8eZYPPUXAcX9c7XKcYORLC6fdwWpjde5ve4UAlLqhK2Ae5b+i7Zc3uOxg2wfP37heimS3JOMmjRAEleGXrWl6/5L6GuH31Dg3Fay2dYsNCxJSJrRpU0k0HYPJMDB03/JUHW7O+2Z+Wq+kL+XYHW7hrKYQigyLiwaQQK6KVImIAzA7AsT/KTbNsd6PgCc53DReQ7peoRI0XpFgex3lFI9vFg2X+1oABzf410yYW5g9fp5KdSKapaDPZaCiT06gX+6v5E5C07Cb6lHhCAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Pm2\"\n        title=\"Pm2\"\n        src=\"/static/744076a86e2e3a876ff825dd4b5677c6/fcda8/pm2.png\"\n        srcset=\"/static/744076a86e2e3a876ff825dd4b5677c6/12f09/pm2.png 148w,\n/static/744076a86e2e3a876ff825dd4b5677c6/e4a3f/pm2.png 295w,\n/static/744076a86e2e3a876ff825dd4b5677c6/fcda8/pm2.png 590w,\n/static/744076a86e2e3a876ff825dd4b5677c6/efc66/pm2.png 885w,\n/static/744076a86e2e3a876ff825dd4b5677c6/c83ae/pm2.png 1180w,\n/static/744076a86e2e3a876ff825dd4b5677c6/11b9b/pm2.png 5375w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Đây là sơ đồ hệ thống deploy nodejs đơn giản nhất, tùy vào yêu cầu có thể sẽ phức tạp hơn như kết hợp CI để quá trình unit test và deploy diễn ra tự động.</p>\n<p><strong>Mình giải thích sơ đồ này 1 chút:</strong></p>\n<p>Khi thực hiện deploy thì máy <strong>Local</strong> sẽ ssh vào 2 server <strong>Test</strong> và <strong>Production</strong>.</p>\n<p>Sau đó đọc file cấu hình deploy của pm2 (ecosystem.config.js) để thực hiện pull source code từ git repository theo branch tương ứng.</p>\n<p>Cuối cùng là start các instance với source code đã pull.</p>\n<h3>Thực hiện</h3>\n<ul>\n<li>Đầu tiên phải đảm bảo rằng Local và các server đã thiết lập môi trường giống như sơ đồ (nginx, git, nodejs…phải đầy đủ đồ chơi nha).</li>\n<li>Thứ high là đảm bảo rằng server Test và Production đã được add SSH key của Local, nếu không khi deploy sẽ phải nhập tay password.</li>\n<li>Thứ bar là đảm bảo rằng tài khoản trên dịch vụ Git (GitHub, GitLab, Bitbucket…) của bạn đã được add SSH key của server Test và Production, nếu ko thì sẽ bị như bên trên.</li>\n<li>Cuối cùng là phải có 1 Nodejs app =)).</li>\n</ul>\n<p>Sau khi pass các điều kiện trên thì bắt đầu thôi, config 1 chút trên server trước.</p>\n<p><strong>Trên Test server:</strong></p>\n<p>Run thần chú <code class=\"language-text\">sudo vi /etc/nginx/sites-available/default</code> để mở file config nginx và cập nhật lại như sau:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">server <span class=\"token punctuation\">{</span>\n    listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span>\n\n    server_name example.com<span class=\"token punctuation\">;</span>\n\n    location / <span class=\"token punctuation\">{</span>\n        proxy_pass http://localhost:3000<span class=\"token punctuation\">;</span>\n        proxy_http_version <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span>\n        proxy_set_header Upgrade <span class=\"token variable\">$http_upgrade</span><span class=\"token punctuation\">;</span>\n        proxy_set_header Connection <span class=\"token string\">'upgrade'</span><span class=\"token punctuation\">;</span>\n        proxy_set_header Host <span class=\"token variable\">$host</span><span class=\"token punctuation\">;</span>\n        proxy_cache_bypass <span class=\"token variable\">$http_upgrade</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Đọc file trên đủ hiểu vai trò của nginx rồi nhé, khi người dùng truy cập <code class=\"language-text\">192.168.1.3</code> với http port mặc định là 80 thì nginx sẽ reverse proxy thành <code class=\"language-text\">http://localhost:3000</code> (3000 chính là port mình start nodejs app)</p>\n<p><strong>Trên Production server:</strong>\nTương tự như trên Test server.</p>\n<p><strong>Tại thư mục project trên Local:</strong></p>\n<p>Run thần chú <code class=\"language-text\">pm2 ecosystem</code> để genarate ra file <strong>ecosystem.config.js</strong></p>\n<p>File này ban đầu sẽ có nội dung tương tự như sau:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  apps <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n    name<span class=\"token operator\">:</span> <span class=\"token string\">'API'</span><span class=\"token punctuation\">,</span>\n    script<span class=\"token operator\">:</span> <span class=\"token string\">'app.js'</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token comment\">// Options reference: https://pm2.keymetrics.io/docs/usage/application-declaration/</span>\n    args<span class=\"token operator\">:</span> <span class=\"token string\">'one two'</span><span class=\"token punctuation\">,</span>\n    instances<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n    autorestart<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n    watch<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    max_memory_restart<span class=\"token operator\">:</span> <span class=\"token string\">'1G'</span><span class=\"token punctuation\">,</span>\n    env<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token constant\">NODE_ENV</span><span class=\"token operator\">:</span> <span class=\"token string\">'development'</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    env_production<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token constant\">NODE_ENV</span><span class=\"token operator\">:</span> <span class=\"token string\">'production'</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\n  deploy <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    production <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      user <span class=\"token operator\">:</span> <span class=\"token string\">'node'</span><span class=\"token punctuation\">,</span>\n      host <span class=\"token operator\">:</span> <span class=\"token string\">'212.83.163.1'</span><span class=\"token punctuation\">,</span>\n      ref  <span class=\"token operator\">:</span> <span class=\"token string\">'origin/master'</span><span class=\"token punctuation\">,</span>\n      repo <span class=\"token operator\">:</span> <span class=\"token string\">'git@github.com:repo.git'</span><span class=\"token punctuation\">,</span>\n      path <span class=\"token operator\">:</span> <span class=\"token string\">'/var/www/production'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'post-deploy'</span> <span class=\"token operator\">:</span> <span class=\"token string\">'npm install &amp;&amp; pm2 reload ecosystem.config.js --env production'</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>Mình cần thay đổi lại cho phù hợp với yêu cầu:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    apps<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n        name<span class=\"token operator\">:</span> <span class=\"token string\">'test-pm2'</span><span class=\"token punctuation\">,</span>\n        append_env_to_name<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n        script<span class=\"token operator\">:</span> <span class=\"token string\">'server.js'</span><span class=\"token punctuation\">,</span>\n        instances<span class=\"token operator\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span>\n        autorestart<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n        max_memory_restart<span class=\"token operator\">:</span> <span class=\"token string\">'1G'</span><span class=\"token punctuation\">,</span>\n        env<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// common env variable</span>\n            <span class=\"token constant\">NODE_ENV</span><span class=\"token operator\">:</span> <span class=\"token string\">'development'</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        env_production<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// khi deploy với option --env production</span>\n            <span class=\"token constant\">NODE_ENV</span><span class=\"token operator\">:</span> <span class=\"token string\">\"production\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token constant\">PORT</span><span class=\"token operator\">:</span> <span class=\"token number\">3000</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        env_development<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// khi deploy với option --env development</span>\n            <span class=\"token constant\">NODE_ENV</span><span class=\"token operator\">:</span> <span class=\"token string\">\"development\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token constant\">PORT</span><span class=\"token operator\">:</span> <span class=\"token number\">3000</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\n    deploy<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        production<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            user<span class=\"token operator\">:</span> <span class=\"token string\">'chungtran-prod'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// user để ssh</span>\n            host<span class=\"token operator\">:</span> <span class=\"token string\">'192.168.1.9'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// IP của server này (theo sơ đồ)</span>\n            ref<span class=\"token operator\">:</span> <span class=\"token string\">'origin/master'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// branch để pull source</span>\n            repo<span class=\"token operator\">:</span> <span class=\"token string\">'git@github.com:chungtran4078/demo-pm2.git'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// repo của project</span>\n            path<span class=\"token operator\">:</span> <span class=\"token string\">'/var/www/html/demo-pm2'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// sẽ deploy vào thư mục này</span>\n            <span class=\"token string\">'post-deploy'</span><span class=\"token operator\">:</span> <span class=\"token string\">'yarn install &amp;&amp; pm2 startOrRestart ecosystem.config.js --env production'</span> <span class=\"token comment\">// cmd để deploy</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        development<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            user<span class=\"token operator\">:</span> <span class=\"token string\">'chungtran-dev'</span><span class=\"token punctuation\">,</span>\n            host<span class=\"token operator\">:</span> <span class=\"token string\">'192.168.1.3'</span><span class=\"token punctuation\">,</span>\n            ref<span class=\"token operator\">:</span> <span class=\"token string\">'origin/develop'</span><span class=\"token punctuation\">,</span>\n            repo<span class=\"token operator\">:</span> <span class=\"token string\">'git@github.com:chungtran4078/demo-pm2.git'</span><span class=\"token punctuation\">,</span>\n            path<span class=\"token operator\">:</span> <span class=\"token string\">'/var/www/html/demo-pm2'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'post-deploy'</span><span class=\"token operator\">:</span> <span class=\"token string\">'yarn install &amp;&amp; pm2 startOrRestart ecosystem.config.js --env development'</span>\n        <span class=\"token punctuation\">}</span>\n\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Nội dung trên cũng khá dễ hiểu rồi, nếu chưa hiểu có thể xem document này nha: <a href=\"https://pm2.keymetrics.io/docs/usage/deployment/#complete-tutorial\" target=\"_blank\" rel=\"nofollow\">https://pm2.keymetrics.io/docs/usage/deployment/#complete-tutorial</a></p>\n<p>Nhớ là phải push file này lên git cùng với source code nữa nha. Vì server sau khi pull về nó sẽ đọc file này để deploy.</p>\n<p>Xong xuôi hết chưa?\nChạy lần lượt các cmd sau để deploy lên Test server:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">pm2 deploy ecosystem.config.js development setup <span class=\"token comment\"># setup ban đầu để chuẩn bị deploy như tạo thư mục, pull code...</span>\npm2 deploy ecosystem.config.js development <span class=\"token comment\"># tiến hành deploy</span></code></pre></div>\n<p>Tương tự với Production server luôn.</p>\n<p>Truy cập <code class=\"language-text\">192.168.1.3</code> để xem app mà mình đã deploy từ branch develop và <code class=\"language-text\">192.168.1.9</code> để xem app mà mình đã deploy từ branch master.</p>","frontmatter":{"title":"Deploy Nodejs app sử dụng Nginx + PM2","date":"2020-04-08","category":"Nodejs","tags":["linux","nodejs","nginx"],"image":null}}},"pageContext":{"slug":"/deploy-nodejs-app-using-nginx-pm2/","previous":{"fields":{"slug":"/docker-cho-be-p3/"},"frontmatter":{"title":"Docker cho bé - P3: Chạy nhiều container với Docker-compose","category":"Docker","tags":["linux","docker","development tools"]}},"next":{"fields":{"slug":"/tai-sao-moi-nguoi-kho-chiu-voi-vue3/"},"frontmatter":{"title":"Vue 3 drama: Tại sao mọi người khó chịu với Vue 3","category":"Vuejs","tags":["vuejs","javascript"]}}}}}