{
    "componentChunkName": "component---src-templates-blog-post-tsx",
    "path": "/docker-cho-be-p2/",
    "result": {"data":{"site":{"siteMetadata":{"title":"Chung Tran","author":"@chungtran4078"}},"markdownRemark":{"id":"f11fce6c-4b83-53e1-bccf-b9d31a2aa6b7","excerpt":"Như ở phần trước mình có giới thiệu qua về Dockerfile Dockerfile: là 1 file text, chứa các cấu hình của một image. Nếu bạn không muốn sử dụng các image có sẵn…","html":"<p>Như ở phần trước mình có giới thiệu qua về Dockerfile</p>\n<blockquote>\n<p>Dockerfile: là 1 file text, chứa các cấu hình của một image. Nếu bạn không muốn sử dụng các image có sẵn từ Docker hub thì bạn cũng có thể build cho riêng mình 1 image bằng Dockerfile.</p>\n</blockquote>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0902b7696a0dc603a79dc5af6412afd0/1ff84/Dockerfile.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 24.324324324324326%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABLElEQVQY022QQUvCYBiA9y86doz+RX+hQ/+kurbw0CXokLduCl4kTAzqsA5GRZAhGJSOpbCpn9Ptm+mmTt2ecBFR9MBzeZ/L+75KpVJhped5rIiiKHHFeOzzVm/gyq8Wx3Hid/eli9k0MJvvLGbTZKZomkYmk0XXdf4yn41pvNaIFwG6NSSKf9pkEfHU8XhuD3ix+hjCYRlFKKqqkk6nMQwDIQSmaTKwe3Qdn9Nrye7JFbm7D4qPNl3Ro9PpMpYO903B1oVguyTYPKuyfljC8ycoqVSKfD6fbBgEAbZtM50E9JwhR+dtDgoB+zmXMJyzXIQ4rsss8DHliL2bFjuXbdaOb9lQC4RhiFIulykWi1iW9fveOKZvC+otGzkc8R/Sk5SrNbLaA0ZbJD/8BE5MZ0pJ+QDAAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Dockerfile\"\n        title=\"Dockerfile\"\n        src=\"/static/0902b7696a0dc603a79dc5af6412afd0/fcda8/Dockerfile.png\"\n        srcset=\"/static/0902b7696a0dc603a79dc5af6412afd0/12f09/Dockerfile.png 148w,\n/static/0902b7696a0dc603a79dc5af6412afd0/e4a3f/Dockerfile.png 295w,\n/static/0902b7696a0dc603a79dc5af6412afd0/fcda8/Dockerfile.png 590w,\n/static/0902b7696a0dc603a79dc5af6412afd0/efc66/Dockerfile.png 885w,\n/static/0902b7696a0dc603a79dc5af6412afd0/1ff84/Dockerfile.png 1040w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\nTrong bài viết này chúng ta sẽ viết 1 Dockerfile đơn giản để build ra 1 image chứa sẵn LAMP stack.</p>\n<h2>Viết Dockerfile</h2>\n<p>Trong thư mục chứa project mình có các file/folder như sau:\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 310px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bb97d0aa3b8ea84fdd4deb710cb3419f/5fad2/folder-file.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.16216216216216%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA9ElEQVQoz41RTUvDQBDNX/UPeCrePPTinxB68NI/IV6qaEsx1Ki1ENEm7SVGi2S2MdnZfTJbNvTDgAMzO/Pe8GbYCQDAWgtvPpdXaw1mPuDaarFggxHUzQVUNPKdTqwgQp5/utwLhNEjru9GzaB90YBd/YFe/xTjy/Od7dS6BJFqBMVOumc4Ou6g3hqyI2gkGoX7xRWWedgQZfmDr9XKbVhVlcMMM8bhBIPbYbughCzL8DqN8RYn+CbliDRJ8PI8RfTwhPn73GFrIsSzGdJ0iaKgdkFjGLWuwazheWk0xji34naDyd+Jbx9v7yiHl/oLwz/7fgGphR4ZpxAP9wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Dockerfile\"\n        title=\"Dockerfile\"\n        src=\"/static/bb97d0aa3b8ea84fdd4deb710cb3419f/5fad2/folder-file.png\"\n        srcset=\"/static/bb97d0aa3b8ea84fdd4deb710cb3419f/12f09/folder-file.png 148w,\n/static/bb97d0aa3b8ea84fdd4deb710cb3419f/e4a3f/folder-file.png 295w,\n/static/bb97d0aa3b8ea84fdd4deb710cb3419f/5fad2/folder-file.png 310w\"\n        sizes=\"(max-width: 310px) 100vw, 310px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<ul>\n<li>webroot (thư mục chứa source code)</li>\n<li>Dockerfile</li>\n<li>start.sh</li>\n</ul>\n<p>Giờ sẽ lần lượt đi viết những file này.</p>\n<h3>Dockerfile</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">FROM ubuntu:16.04\n\nRUN <span class=\"token assign-left variable\">DEBIAN_FRONTEND</span><span class=\"token operator\">=</span>noninteractive\n\nRUN <span class=\"token function\">apt-get</span> update\n\n<span class=\"token comment\"># Install apache</span>\nRUN <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> -y apache2\n\n<span class=\"token comment\"># Install php</span>\nRUN <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> -y php libapache2-mod-php php-mcrypt php-mysql\n\t\n<span class=\"token comment\"># Install mysql</span>\nRUN <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"mysql-server mysql-server/root_password password root\"</span> <span class=\"token operator\">|</span> debconf-set-selections <span class=\"token punctuation\">\\</span>\n    <span class=\"token operator\">&amp;&amp;</span> <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"mysql-server mysql-server/root_password_again password root\"</span> <span class=\"token operator\">|</span> debconf-set-selections <span class=\"token punctuation\">\\</span>\n    <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> -y mysql-server\n\t\nWORKDIR /var/www/html\n\nRUN <span class=\"token function\">mkdir</span> /boot_script\nCOPY start.sh /boot_script\nRUN <span class=\"token function\">chmod</span> a+x /boot_script/*\n\n\nENTRYPOINT <span class=\"token punctuation\">[</span><span class=\"token string\">\"/boot_script/start.sh\"</span><span class=\"token punctuation\">]</span>\n\nEXPOSE <span class=\"token number\">80</span></code></pre></div>\n<p><strong>* Giải thích:</strong></p>\n<ul>\n<li><strong>FROM</strong> image gốc, tức là 1 image chứa hệ điều hành, có thể là centos hoặc ubuntu. Ở trên là mình muốn container (máy ảo) của mình sẽ chạy ubuntu version 16.04. Nếu image <code class=\"language-text\">ubuntu:16.04</code> chưa được pull về (chưa có ở local) thì nó cũng sẽ tự động pull về từ Docker hub.</li>\n<li><strong>RUN</strong> thực thi các câu lệnh linux. Ở VD trên mình đã thực hiện cài đặt apache, php, mysql.</li>\n</ul>\n<p>Chỗ này có đoạn <code class=\"language-text\">RUN DEBIAN_FRONTEND=noninteractive</code> có thể bạn sẽ thắc mắc, thì mục đích nó như sau:</p>\n<p>Trong quá trình cài đặt apache và mysql thì hệ thống thường hỏi <code class=\"language-text\">yes/no</code> lúc này ta gõ <code class=\"language-text\">y</code> hoặc <code class=\"language-text\">yes</code> để bắt đầu cài đặt. Tuy nhiên ở Docker thì các câu lệnh này sẽ được chạy khi build image và để nó diễn ra tự động thì mình cần tắt chế độ tương tác bằng <code class=\"language-text\">RUN DEBIAN_FRONTEND=noninteractive</code>, sau đó thêm option <code class=\"language-text\">-y</code> (nghĩa là yes) ở cú pháp cài đặt apache và mysql. Như vậy trong quá trình cài đặt đến chỗ <code class=\"language-text\">yes/no</code> sẽ tự động trả lời là <code class=\"language-text\">yes</code>.</p>\n<ul>\n<li><strong>WORKDIR</strong> thư mục làm việc, khi truy cập vào container sẽ tự động cd đến thư mục này.</li>\n<li><strong>COPY</strong> sao chép 1 file/thư mục từ máy thật vào images, ở VD trên mình sao chép file <code class=\"language-text\">start.sh</code> và thư mục <code class=\"language-text\">/boot_script</code> của images.</li>\n<li><strong>ENTRYPOINT</strong> thiết lập các lệnh, tham số sẽ được thực thi khi container được chạy.</li>\n<li><strong>EXPOSE</strong> port mà container sẽ lắng nghe khi chạy. Ở đây mình dùng port 80 cho HTTP.</li>\n</ul>\n<h3>start.sh</h3>\n<p>Đây là file được nhắc đến trong Dockerfile nãy giờ đây, thật ra nó cũng chỉ là vài câu lệnh linux thôi. Mục đích như mình đã nói ở <strong>ENTRYPOINT</strong> là mình muốn nó chạy khi container chạy.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash</span>\n<span class=\"token function\">usermod</span> -d /var/lib/mysql/ mysql\n<span class=\"token function\">chown</span> -R mysql /var/lib/mysql/\n<span class=\"token function\">service</span> apache2 start\n<span class=\"token function\">service</span> mysql start\n<span class=\"token builtin class-name\">exec</span> <span class=\"token variable\">$@</span></code></pre></div>\n<p>Tiện thể mình giải thích luôn mục đích của mình với mấy câu lệnh trên là “Mình muốn khi container chạy thì đồng thời cũng khởi động apache và mysql”</p>\n<h2>Thực hiện build image</h2>\n<p>Mở cmd tại thư mục project (thư mục mà chứa Dockerfile) và run lệnh sau:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">docker build -t lamp-image <span class=\"token builtin class-name\">.</span></code></pre></div>\n<ul>\n<li><strong>lamp-image</strong> là tên do mình tự đặt cho image</li>\n</ul>\n<p>Lúc này Docker sẽ thực hiện pull những image cần thiết và build image, quá trình này phụ thuộc vào tốc độ mạng. Sau khi build xong thử run <code class=\"language-text\">docker images</code> ta sẽ được như sau.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2349d2b57054bcc13e2d5de92c281011/a242d/docker-image.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 11.486486486486488%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAhUlEQVQI1x2MMQqDMAAAfUcdBDWJmIjGaBbTIaAG3HQolP7/HVd0vOO47PP9cRwHfp6p65plCcQYUUrSNAJtDNd5sa0bzjmKoiCENyklpmnCGIO1I/u+U1UVWVwT3s+40dL3Pd57QggIIXjl+RPd3lqL1pqyLGlbzTAMdF2HlBKlmofv4R93UD9sOZI96AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Docker images\"\n        title=\"Docker images\"\n        src=\"/static/2349d2b57054bcc13e2d5de92c281011/fcda8/docker-image.png\"\n        srcset=\"/static/2349d2b57054bcc13e2d5de92c281011/12f09/docker-image.png 148w,\n/static/2349d2b57054bcc13e2d5de92c281011/e4a3f/docker-image.png 295w,\n/static/2349d2b57054bcc13e2d5de92c281011/fcda8/docker-image.png 590w,\n/static/2349d2b57054bcc13e2d5de92c281011/a242d/docker-image.png 724w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2>Chạy container</h2>\n<p>Giờ đã có 1 image chứa LAMP rồi, mình có thể run bao nhiêu web server tùy ý, ở đây 1 webserver là 1 container.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">docker run -d --name lamp-container -v D:<span class=\"token punctuation\">\\</span>RD<span class=\"token punctuation\">\\</span>Docker<span class=\"token punctuation\">\\</span>begin-docker<span class=\"token punctuation\">\\</span>webroot:/var/www/html -p <span class=\"token number\">9000</span>:80 -it lamp-image <span class=\"token function\">bash</span></code></pre></div>\n<p>Câu lệnh này sẽ thực hiện chạy một container có tên là <strong>lamp-container</strong>, mapping thư mục <strong>D:\\RD\\Docker\\begin-docker\\webroot</strong> trên máy thật với thư mục <strong>/var/www/html</strong> trên container, mapping port <strong>9000</strong> của máy thật với port <strong>80</strong> trên container, chạy với <strong>chế độ nền</strong> và sử dụng image <strong>lamp-image</strong>.</p>\n<p>Sau khi chạy, kiểm tra với lệnh <code class=\"language-text\">docker ps</code> ta có kết quả:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f34b8b80cb50cfd7c3293b1ecd11c759/cd1d6/docker-ps.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 6.756756756756756%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAARUlEQVQI1x3JSwrAIAwA0Z5FE8R86sqsW3r/M03B1TyY63k/am8yb6oKVWGMQWaettZwd+aciAgRgarSe8cjMLPz1lrHP7oQHgsenF7wAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Docker containers\"\n        title=\"Docker containers\"\n        src=\"/static/f34b8b80cb50cfd7c3293b1ecd11c759/fcda8/docker-ps.png\"\n        srcset=\"/static/f34b8b80cb50cfd7c3293b1ecd11c759/12f09/docker-ps.png 148w,\n/static/f34b8b80cb50cfd7c3293b1ecd11c759/e4a3f/docker-ps.png 295w,\n/static/f34b8b80cb50cfd7c3293b1ecd11c759/fcda8/docker-ps.png 590w,\n/static/f34b8b80cb50cfd7c3293b1ecd11c759/efc66/docker-ps.png 885w,\n/static/f34b8b80cb50cfd7c3293b1ecd11c759/cd1d6/docker-ps.png 1141w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Vậy là ta đã có 1 container đang chạy, tiếp tục trong thư mục <strong>webroot</strong> thử tạo file <strong>index.php</strong> với nội dung:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token function\">phpinfo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token delimiter important\">?></span></span></code></pre></div>\n<p>Vào trình duyệt truy cập <strong>localhost:9000</strong> xem có gì nhé.</p>\n<h2>Mở rộng 1 image</h2>\n<p>Nếu bạn để ý cú pháp Dockerfile thì sẽ phát hiện <strong>FROM ubuntu:16.04</strong> thực chất là chúng ta đang mở rộng image <strong>ubuntu:16.04</strong> bằng việc cài thêm apache, php, mysql.</p>\n<p>Như vậy việc mở rộng 1 image dựa trên image đã có cũng thực hiện tương tự.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">FROM lamp-image\nRUN <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> -y <span class=\"token function\">vim</span></code></pre></div>\n<p>Build 1 image mới từ Dockerfile trên.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">docker build -t lamp-vim-image <span class=\"token builtin class-name\">.</span></code></pre></div>\n<p>Như bạn thấy image <strong>lamp-image</strong> chưa được cài <strong>vim</strong> (<a href=\"/su-dung-vim-trong-linux/\">một editor trong linux</a>) mình đã mở rộng image này bằng việc build 1 image mới tên là <strong>lamp-vim-image</strong> được cài đặt <strong>vim</strong>.</p>\n<p>Giờ thử chạy 1 container từ image vừa build xem đã sử dụng được <strong>vim</strong> chưa nhé.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">docker run --name lamp-vim-container -it lamp-vim-image <span class=\"token function\">bash</span></code></pre></div>","frontmatter":{"title":"Docker cho bé - P2: Build image từ Dockerfile","date":"2019-04-28","category":"Docker","tags":["linux","docker","development tools"],"image":null}}},"pageContext":{"slug":"/docker-cho-be-p2/","previous":{"fields":{"slug":"/docker-cho-be-p1/"},"frontmatter":{"title":"Docker cho bé - P1: Hello Docker!","category":"Docker","tags":["linux","docker","development tools"]}},"next":{"fields":{"slug":"/docker-cho-be-p3/"},"frontmatter":{"title":"Docker cho bé - P3: Chạy nhiều container với Docker-compose","category":"Docker","tags":["linux","docker","development tools"]}}}},
    "staticQueryHashes": ["3649515864","3894061898"]}