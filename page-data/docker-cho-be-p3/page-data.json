{"componentChunkName":"component---src-templates-blog-post-js","path":"/docker-cho-be-p3/","result":{"data":{"site":{"siteMetadata":{"title":"Chung Tran","author":"@chungtran4078"}},"markdownRemark":{"id":"0af48826-b482-59eb-b8ea-eabb733a621f","excerpt":"Đến đây chúng ta có thể sử dụng Dockerfile để khởi tạo một server và cài đặt các service cần thiết lên đó rồi. Tuy nhiên sẽ có những bất cập, đó là chúng ta…","html":"<p>Đến đây chúng ta có thể sử dụng <strong>Dockerfile</strong> để khởi tạo một server và cài đặt các service cần thiết lên đó rồi.</p>\n<p>Tuy nhiên sẽ có những bất cập, đó là chúng ta phải cài tất cả service lên 1 container (kiến trúc 1 khối - monolithic), mà các service này lại phải cài đặt thủ công (<code class=\"language-text\">apt-get install xxxyyy</code> gì gì đó), trong khi chúng ta muốn sử dụng các image service có sẵn trên Docker hub ???</p>\n<p>Hoặc 1 dự án thực tế sử dụng các service chạy độc lập (kiến trúc nhiều dịch vụ - microservice) chẳng lẽ chúng ta lại phải viết vài cái <strong>Dockerfile</strong> nữa sao. Không không, ở đây chúng ta không làm như vậy.</p>\n<p>Vậy giải pháp là <strong>Docker compose</strong> (nghe giống giống cái <strong>php composer</strong> nhỉ, thực ra có giống đấy, lát mình nói sau).</p>\n<p><strong>Docker compose</strong> là công cụ cho phép chúng ta run nhiều container 1 lúc, mình có chém qua về nó ở P1.</p>\n<blockquote>\n<p>Docker compose: thay vì cài đặt tất cả service (mysql, php, redis…) lên 1 container thì chúng ta có thể sử dụng docker-compose để chạy mỗi service trên mỗi container và kết nối các container lại với nhau. Giống như một hệ thống thực tế vậy.</p>\n</blockquote>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/24ae150e7b2b17a62701bda7ca132c75/00d43/docker-compose.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 39.86486486486486%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABXElEQVQY03VR3U+CcBTlf62XXnxp67WnHmqtr62Ray2bOZciZgYpCuQHZmYopmQ4ZippYkpL0ZLxI9J8kNXZ3d3dPffs7twLGfMAAOgAmEVdekneFVCMClE3xj+ALEowUXbfOkcIdRZhcaZ0jBBYmJyyVjGYdX8X1uoLDmrFSYRiLMVWyaxIZITV9b2+OjTZsa7rwNAmo2ZA2cIDcZ3IFXmKSdNM+iaTXdpxowxHMSyRZMl0EXZh+3YH3+7RkkLWupeijIlyuNqJNXpQpfrMC5XHilgsC5kc11XeS7ygaVpNaoYT9/5Iagt22GD/mi/+JLX6GhAVtfExavRHzcEnZLHxNR57LohsvoQGCTeecl+lAnh0cddjg88V+dXiHAIz/LgxDFUdOr3BQyeCBLDNA5fPj23DJ3goynGFqcxMU8Nz155yrbZMJzO3+bL9FA1G4st+dsNLq4PBn6/6BsIOpDMTXt92AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Docker composer\"\n        title=\"Docker composer\"\n        src=\"/static/24ae150e7b2b17a62701bda7ca132c75/fcda8/docker-compose.png\"\n        srcset=\"/static/24ae150e7b2b17a62701bda7ca132c75/12f09/docker-compose.png 148w,\n/static/24ae150e7b2b17a62701bda7ca132c75/e4a3f/docker-compose.png 295w,\n/static/24ae150e7b2b17a62701bda7ca132c75/fcda8/docker-compose.png 590w,\n/static/24ae150e7b2b17a62701bda7ca132c75/efc66/docker-compose.png 885w,\n/static/24ae150e7b2b17a62701bda7ca132c75/00d43/docker-compose.png 1000w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>Cài đặt</h2>\n<p>Mình xài Windows cài xong Docker cái thấy nó có sẵn <strong>Docker compose</strong> luôn, ai xài Linux thì tham khảo hướng dẫn ở đây nha <a href=\"https://docs.docker.com/compose/install/\" target=\"_blank\" rel=\"nofollow\">https://docs.docker.com/compose/install/</a></p>\n<p>Kiểm tra xem cài đặt thành công chưa</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">docker-compose -v</code></pre></div>\n<h2>Viết docker-compose.yml</h2>\n<p>Trước tiên phải xác định các container sẽ sử dụng trong project. Ví dụ dự án mình là dự án php cần có 1 máy chạy source code và 1 máy để chạy mysql. Vậy là mình cần có 2 container.</p>\n<p>Như vậy nội dung file <strong>docker-compose.yml</strong> cho project của mình về cơ bản sẽ như sau:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">version: &#39;3.5&#39;\nservices:\n    php-apache:\n        build: .\n        ports:\n            - 8080:80 #&lt;host&gt;:&lt;container&gt;\n        volumes:\n            - ./source:/var/www/html #Mapping source code giữa máy thật (host) và container\n            - ./apache/log:/var/log/apache2\n        links:\n            - mysql\n        environment:\n            DB_HOST: mysql #Là tên của container database nha\n            DB_PORT: 3306\n            DB_NAME: my-db\n            DB_USER: devuser\n            DB_PWD: devuser\n    mysql:\n        image: mysql:5.6\n        ports:\n            - &quot;3307:3306&quot; #&lt;host&gt;:&lt;container&gt;\n        environment:\n            MYSQL_ROOT_PASSWORD: root #Mặc định đã có user root rồi nên chỉ cần thiết lập password cho user này.\n            MYSQL_DATABASE: my-db #Tạo sẵn db my-db\n            MYSQL_USER: devuser #User này sẽ được tạo và grant cho my-db, không để root vì user root mặc định có sẵn rồi.\n            MYSQL_PASSWORD: devuser\n        volumes: #Vì dữ liệu sẽ mất nếu stop container vì vậy phải backup data vào máy thật\n            - ./db/data:/var/lib/mysql \n            - ./db/log:/var/log/mysql</code></pre></div>\n<p>Và nội dung của <strong>Dockerfile</strong> như sau:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">FROM php:7.3-apache\n#https://hub.docker.com/_/php\nLABEL maintainer=&quot;ChungTran&lt;chungtran4078@gmail.com&gt;&quot;\nRUN docker-php-ext-install pdo pdo_mysql mysqli\nRUN cp &quot;$PHP_INI_DIR/php.ini-production&quot; &quot;$PHP_INI_DIR/php.ini&quot;\nRUN apt-get update &amp;&amp; apt-get install -y vim</code></pre></div>\n<h4>** Giải thích chút:</h4>\n<p>Cấu trúc file <strong>docker-compose.yml</strong> của mình ở trên như sau:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">version: &#39;3.5&#39;\nservices:\n    php-apache:\n        ...\n    mysql:\n        ...</code></pre></div>\n<ul>\n<li>Mỗi container là một <em>service</em>, ở đây mình có 2 service có tên <em>php-apache</em> và <em>mysql</em> (tên này do mình tự đặt nha)</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">php-apache:\n        build: .</code></pre></div>\n<p>Chỗ này là lý do có file <strong>Dockerfile</strong> ở trên. Do mình muốn cài đặt thêm một số thành phần nên mình sẽ chạy service này với image build từ <strong>Dockerfile</strong>. </p>\n<p>Hiện tại file <strong>Dockerfile</strong> đang ở cùng cấp với file <strong>docker-compose.yml</strong> nên mình để <code class=\"language-text\">build: .</code> nha, nếu <strong>Dockerfile</strong> nằm thư mục khác, VD <em>docker</em> thì:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">build:\n    context: ./docker</code></pre></div>\n<p><em>**Lưu ý: <strong>docker-compose.yml</strong> có version nha các bạn, ở VD trên mình đang dùng <code class=\"language-text\">version 3.5</code>, các version có thể khác nhau về một số cú pháp, chi tiết tại đây: <a href=\"https://docs.docker.com/compose/compose-file/compose-versioning/\" target=\"_blank\" rel=\"nofollow\">https://docs.docker.com/compose/compose-file/compose-versioning/</a></em></p>\n<p>Ok xong xuôi, thực hiện <code class=\"language-text\">docker-composer up</code>, ta sẽ thấy các container lần lượt được start.</p>\n<p>Bây giờ nếu nhấn Ctrl + C thì các container sẽ stop, trường hợp này sử dụng <code class=\"language-text\">docker-composer up -d</code> để chạy với chế độ nền.</p>\n<h2>Testing</h2>\n<p>Vào thư mục <em>source</em>, tạo file <em>index.php</em>:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token variable\">$dbhost</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_ENV</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'DB_HOST'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$username</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_ENV</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'DB_USER'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$password</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_ENV</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'DB_PWD'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$dbname</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_ENV</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'DB_NAME'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$port</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_ENV</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'DB_PORT'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Create connection</span>\n<span class=\"token variable\">$conn</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysqli_connect</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$dbhost</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$username</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$password</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$dbname</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$port</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Check connection</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token variable\">$conn</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">die</span><span class=\"token punctuation\">(</span><span class=\"token double-quoted-string string\">\"Connection failed: \"</span> <span class=\"token punctuation\">.</span> <span class=\"token function\">mysqli_connect_error</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">echo</span> <span class=\"token double-quoted-string string\">\"Connected successfully\"</span><span class=\"token punctuation\">;</span></span></code></pre></div>\n<p>Sau đó truy cập <code class=\"language-text\">localhost:8080</code> để xem kết quả.</p>\n<p>Một số trường hợp có thể sẽ xảy ra lỗi <code class=\"language-text\">Call to undefined function mysqli_connect()</code> hoặc <code class=\"language-text\">Connection refused</code> hoặc <code class=\"language-text\">No such file or directory</code> thì kiểm tra lại file <strong>php.ini</strong> trong <code class=\"language-text\">/usr/local/etc/php</code> nhé.</p>\n<ul>\n<li>Enable mysqli extension (extension=mysqli)</li>\n<li>Kiểm tra giá trị của <code class=\"language-text\">variables_order</code>, sửa lại thành “EGPCS”. Đây là chuỗi ký tự đại diện cho các biến môi trường (<a href=\"http://php.net/variables-order\" target=\"_blank\" rel=\"nofollow\">http://php.net/variables-order</a>)</li>\n</ul>\n<h3>Thế Docker Compose thì liên quan gì PHP Composer?</h3>\n<p>CHẢ LIÊN QUAN.</p>\n<p>Nhưng mục đích thì có phần giống nhau.</p>\n<ul>\n<li>php composer: cứ nhập tên package vào file <code class=\"language-text\">composer.json</code>, composer sẽ làm việc còn lại.</li>\n<li>docker compose:  cứ nhập tên service và image đi kèm vào file <code class=\"language-text\">docker-compose.yml</code>, docker compose sẽ làm việc còn lại.</li>\n</ul>","frontmatter":{"title":"Docker cho bé - P3: Chạy nhiều container với Docker-compose","date":"2019-05-19","category":"Docker","tags":["linux","docker","development tools"],"image":null}}},"pageContext":{"slug":"/docker-cho-be-p3/","previous":{"fields":{"slug":"/docker-cho-be-p2/"},"frontmatter":{"title":"Docker cho bé - P2: Build image từ Dockerfile","category":"Docker","tags":["linux","docker","development tools"]}},"next":{"fields":{"slug":"/deploy-nodejs-app-using-nginx-pm2/"},"frontmatter":{"title":"Deploy Nodejs app sử dụng Nginx + PM2","category":"Nodejs","tags":["linux","nodejs","nginx"]}}}}}